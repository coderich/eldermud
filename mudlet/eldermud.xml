<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE MudletPackage>
<MudletPackage version="1.001">
	<TriggerPackage />
	<TimerPackage />
	<AliasPackage />
	<ActionPackage />
	<ScriptPackage>
		<ScriptGroup isActive="yes" isFolder="yes">
			<name>component</name>
			<packageName></packageName>
			<script></script>
			<eventHandlerList />
			<Script isActive="yes" isFolder="no">
				<name>layout</name>
				<packageName></packageName>
				<script>eldermud = eldermud or {}

clearWindow();
disableScrollBar();

-- Regions
local topRegion = Geyser.Container:new({
  name = 'topRegion',
  x = 0, y = 0, width = '100%', height = '50%',
});

local bottomRegion = Geyser.Container:new({
  name = 'bottomRegion',
  x = 0, y = '-50%', width = '100%', height = '50%',
});

-- Containers
eldermud.mapContainer = Geyser.Container:new({
  name = 'mapContainer',
  x = 0, y = 0, width = '50%', height = '100%',
}, topRegion);

eldermud.consoleContainer = Geyser.Container:new({
  name = 'consoleContainer',
  x = 0, y = 0, width = '100%', height = '100%',
}, bottomRegion);
</script>
				<eventHandlerList />
			</Script>
			<Script isActive="yes" isFolder="no">
				<name>cmdLine</name>
				<packageName></packageName>
				<script>eldermud = eldermud or {}

clearCmdLine()
enableCommandLine()
killAnonymousEventHandler(eldermud.cmdLineHandlerId or -1)

setCmdLineStyleSheet("main", [[
  QPlainTextEdit {
    padding-left: 0px;
    color: black;
    background-color: grey;
  }
]])

eldermud.cmdLineHandlerId = registerAnonymousEventHandler("sysDataSendRequest", function(e, text)
  clearCmdLine()
  sendGMCP("eldermud.cmd" .. yajl.to_string{text = text})
end)
</script>
				<eventHandlerList />
			</Script>
			<Script isActive="yes" isFolder="no">
				<name>eldermud.console</name>
				<packageName></packageName>
				<script>eldermud = eldermud or {}

local console = Geyser.MiniConsole:new({
  name = "console",
  x = 0, y = 10, width = "100%", height = "100%",
  -- color = "black",
  fontSize = 14,
  autoWrap = true,
  scrollBar = false,
}, eldermud.consoleContainer);

local handlers = {
  ["gmcp.eldermud.text"] = function() console:cecho(gmcp.eldermud.text .. "\n") end,
  ["gmcp.eldermud.dialog"] = function() console:cecho("\n" .. gmcp.eldermud.dialog .. "\n") end,
};

function eldermud:console(e)
  handlers[e]();
end;

console:clear();
-- console:enableCommandLine();
-- console:setCmdAction(cmd);
</script>
				<eventHandlerList>
					<string>gmcp.eldermud.text</string>
				</eventHandlerList>
			</Script>
			<Script isActive="yes" isFolder="no">
				<name>eldermud.map</name>
				<packageName></packageName>
				<script>eldermud = eldermud or {}

-- deleteMap();

Geyser.Mapper:new({
  name = "mapper",
  x = 0, y = 0, width = "100%", height = "100%"
}, eldermud.mapContainer)

setMapZoom(25)
setCustomEnvColor(0, 0, 0, 0, 255);
setCustomEnvColor(1, 255, 0, 0, 255);

function eldermud:map()
  local areaId = 1
  deleteArea(areaId)
  clearAreaUserData(areaId)
  setAreaName(areaId, gmcp.eldermud.map.name)
  
  for i,room in ipairs(gmcp.eldermud.map.rooms) do
    addRoom(i);
    setRoomArea(i, areaId);
    setRoomCoordinates(i, room.x, room.y, room.z);
  end
  
  for i,exit in ipairs(gmcp.eldermud.map.exits) do
    for k,v in pairs(exit) do
      setExit(i, v, k)
      setRoomEnv(i, 0);
      -- setRoomChar(i, "â˜ ");
      -- setRoomChar(i, "T");
    end
  end
  
  centerview(gmcp.eldermud.map.room)
end


-- 
-- killAnonymousEventHandler(impetus.mapHandlerId or -1)
-- 
-- downloadFile(getMudletHomeDir() .. "/map.xml", "http://localhost:8000/map.xml")
-- 
-- impetus.mapHandlerId = registerAnonymousEventHandler("sysDownloadDone", function(_, location)
  -- local mapper = Geyser.Mapper:new({
    -- name = "mapper",
    -- x = 0, y = 0, width = "100%", height = "100%",
  -- }, impetus.mapContainer)
-- 
  -- loadMap(location)
  -- setMapZoom(20)
  -- centerview(1)
-- end)

-- deleteArea(1)
-- local areaId = 1;
-- setAreaName(areaId, "impetus")
-- 
-- local room1 = createRoomID()
-- addRoom(room1)
-- setRoomCoordinates(room1, 0, 0, 0)
-- setRoomArea(room1, areaId)
-- 
-- local room2 = createRoomID()
-- addRoom(room2)
-- setRoomCoordinates(room2, 0, 2, 0)
-- setRoomArea(room2, areaId)
-- 
-- setExit(room1, room2, "n");
-- setExit(room2, room1, "s");
-- setDoor(room1, "n", 1)
-- setDoor(room2, "s", 3)
-- 
-- centerview(room1)
-- setMapZoom(15)
-- 
</script>
				<eventHandlerList>
					<string>gmcp.eldermud.map</string>
				</eventHandlerList>
			</Script>
			<Script isActive="yes" isFolder="no">
				<name>eldermud.login</name>
				<packageName></packageName>
				<script>eldermud = eldermud or {}

function eldermud:login()
  sendGMCP("eldermud.login" .. yajl.to_string{option = "guest"})
end;
</script>
				<eventHandlerList>
					<string>gmcp.eldermud.login</string>
				</eventHandlerList>
			</Script>
			<Script isActive="yes" isFolder="no">
				<name>eldermud.room</name>
				<packageName></packageName>
				<script>eldermud = eldermud or {}

function eldermud:room()
  display(gmcp.eldermud.room)
end;
</script>
				<eventHandlerList>
					<string>gmcp.eldermud.room</string>
				</eventHandlerList>
			</Script>
		</ScriptGroup>
	</ScriptPackage>
	<KeyPackage />
	<HelpPackage>
		<helpURL></helpURL>
	</HelpPackage>
</MudletPackage>
